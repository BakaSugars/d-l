!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Dark",[],e):"object"==typeof exports?exports.Dark=e():t.Dark=e()}(window,function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=7)}([function(t,e,r){"use strict";(function(t){var n=void 0!==t&&t||"undefined"!=typeof self&&self||window,i=Function.prototype.apply;function o(t,e){this._id=t,this._clearFn=e}e.setTimeout=function(){return new o(i.call(setTimeout,n,arguments),clearTimeout)},e.setInterval=function(){return new o(i.call(setInterval,n,arguments),clearInterval)},e.clearTimeout=e.clearInterval=function(t){t&&t.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(n,this._id)},e.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},e.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},e._unrefActive=e.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;e>=0&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},e))},r(8),e.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==t&&t.setImmediate||void 0,e.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==t&&t.clearImmediate||void 0}).call(this,r(1))},function(t,e,r){"use strict";var n,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"===("undefined"==typeof window?"undefined":i(window))&&(n=window)}t.exports=n},function(t,e){t.exports="#define FILL\nprecision {precision} float;\n\nattribute vec3 a_pos;\nattribute float a_infos;\nattribute vec4 a_color;\n\nuniform mat4 u_matrix_array[25];\nuniform int u_coord_id;\nvarying vec4 v_color;\n\nvoid main() {\n    float infos = float(a_infos);\n    float offsetY = mod(a_infos, 2.) - 0.5;\n    infos = (infos - mod(a_infos, 2.)) / 2.;\n    float offsetX = mod(infos, 2.) - 0.5;\n    float size = (infos - mod(infos, 2.)) / 2.;\n    vec2 offset = vec2(offsetX, offsetY) * size;\n    vec3 pos = a_pos + vec3(offset, 0);\n    \n    // float color = float(a_color);\n    // float a = mod(color, 256.) / 255.;\n    // color = (color - a) / 256.;\n    // float b = mod(color, 256.) / 255.;\n    // color = (color - a) / 256.;\n    // float g = mod(color, 256.) / 255.;\n    // float r = color = (color - a) / 256.;\n\n    v_color = a_color / 255.;\n\n    // posProcess\n    gl_Position = u_matrix_array[u_coord_id] * vec4(pos, 1);\n}\n"},function(t,e){t.exports="#define FILL\nprecision {precision} float;\n\nvarying vec4 v_color;\n\nvoid main() {\n    vec4 color = v_color;\n\n    gl_FragColor = color;\n}"},function(t,e){t.exports="#define FILL\nprecision {precision} float;\n\nattribute vec3 a_pos;\nattribute float a_infos;\nattribute vec4 a_color;\n\nuniform mat4 u_matrix_array[25];\nuniform int u_coord_id;\nvarying vec4 v_color;\n\nvoid main() {\n    float infos = float(a_infos);\n    float offsetY = mod(a_infos, 2.) - 0.5;\n    infos = (infos - mod(a_infos, 2.)) / 2.;\n    float offsetX = mod(infos, 2.) - 0.5;\n    float size = (infos - mod(infos, 2.)) / 2.;\n    vec2 offset = vec2(offsetX, offsetY) * size;\n    vec3 pos = a_pos + vec3(offset, 0);\n    \n    // float color = float(a_color);\n    // float a = mod(color, 256.) / 255.;\n    // color = (color - a) / 256.;\n    // float b = mod(color, 256.) / 255.;\n    // color = (color - a) / 256.;\n    // float g = mod(color, 256.) / 255.;\n    // float r = color = (color - a) / 256.;\n\n    v_color = a_color / 255.;\n\n    // posProcess\n    gl_Position = u_matrix_array[u_coord_id] * vec4(pos, 1);\n}\n"},function(t,e){t.exports="#define FILL\nprecision {precision} float;\n\nvarying vec4 v_color;\n\nvoid main() {\n    vec4 color = v_color;\n\n    gl_FragColor = color;\n}"},function(t,e,r){"use strict";var n,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o="object"===("undefined"==typeof Reflect?"undefined":i(Reflect))?Reflect:null,s=o&&"function"==typeof o.apply?o.apply:function(t,e,r){return Function.prototype.apply.call(t,e,r)};n=o&&"function"==typeof o.ownKeys?o.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var a=Number.isNaN||function(t){return t!=t};function u(){u.init.call(this)}t.exports=u,u.EventEmitter=u,u.prototype._events=void 0,u.prototype._eventsCount=0,u.prototype._maxListeners=void 0;var c=10;function f(t){return void 0===t._maxListeners?u.defaultMaxListeners:t._maxListeners}function h(t,e,r,n){var o,s,a,u;if("function"!=typeof r)throw new TypeError('The "listener" argument must be of type Function. Received type '+(void 0===r?"undefined":i(r)));if(void 0===(s=t._events)?(s=t._events=Object.create(null),t._eventsCount=0):(void 0!==s.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),s=t._events),a=s[e]),void 0===a)a=s[e]=r,++t._eventsCount;else if("function"==typeof a?a=s[e]=n?[r,a]:[a,r]:n?a.unshift(r):a.push(r),(o=f(t))>0&&a.length>o&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=t,c.type=e,c.count=a.length,u=c,console&&console.warn&&console.warn(u)}return t}function l(t,e,r){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:r},i=function(){for(var t=[],e=0;e<arguments.length;e++)t.push(arguments[e]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,s(this.listener,this.target,t))}.bind(n);return i.listener=r,n.wrapFn=i,i}function p(t,e,r){var n=t._events;if(void 0===n)return[];var i=n[e];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(i):y(i,i.length)}function _(t){var e=this._events;if(void 0!==e){var r=e[t];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function y(t,e){for(var r=new Array(e),n=0;n<e;++n)r[n]=t[n];return r}Object.defineProperty(u,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(t){if("number"!=typeof t||t<0||a(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");c=t}}),u.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},u.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||a(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},u.prototype.getMaxListeners=function(){return f(this)},u.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e.push(arguments[r]);var n="error"===t,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var u=i[t];if(void 0===u)return!1;if("function"==typeof u)s(u,this,e);else{var c=u.length,f=y(u,c);for(r=0;r<c;++r)s(f[r],this,e)}return!0},u.prototype.addListener=function(t,e){return h(this,t,e,!1)},u.prototype.on=u.prototype.addListener,u.prototype.prependListener=function(t,e){return h(this,t,e,!0)},u.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+(void 0===e?"undefined":i(e)));return this.on(t,l(this,t,e)),this},u.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+(void 0===e?"undefined":i(e)));return this.prependListener(t,l(this,t,e)),this},u.prototype.removeListener=function(t,e){var r,n,o,s,a;if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+(void 0===e?"undefined":i(e)));if(void 0===(n=this._events))return this;if(void 0===(r=n[t]))return this;if(r===e||r.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(o=-1,s=r.length-1;s>=0;s--)if(r[s]===e||r[s].listener===e){a=r[s].listener,o=s;break}if(o<0)return this;0===o?r.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(r,o),1===r.length&&(n[t]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",t,a||e)}return this},u.prototype.off=u.prototype.removeListener,u.prototype.removeAllListeners=function(t){var e,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[t]),this;if(0===arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(void 0!==e)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this},u.prototype.listeners=function(t){return p(this,t,!0)},u.prototype.rawListeners=function(t){return p(this,t,!1)},u.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):_.call(t,e)},u.prototype.listenerCount=_,u.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},function(t,e,r){t.exports=r(10)},function(t,e,r){"use strict";(function(t,e){!function(t,r){if(!t.setImmediate){var n,i,o,s,a,u=1,c={},f=!1,h=t.document,l=Object.getPrototypeOf&&Object.getPrototypeOf(t);l=l&&l.setTimeout?l:t,"[object process]"==={}.toString.call(t.process)?n=function(t){e.nextTick(function(){_(t)})}:!function(){if(t.postMessage&&!t.importScripts){var e=!0,r=t.onmessage;return t.onmessage=function(){e=!1},t.postMessage("","*"),t.onmessage=r,e}}()?t.MessageChannel?((o=new MessageChannel).port1.onmessage=function(t){_(t.data)},n=function(t){o.port2.postMessage(t)}):h&&"onreadystatechange"in h.createElement("script")?(i=h.documentElement,n=function(t){var e=h.createElement("script");e.onreadystatechange=function(){_(t),e.onreadystatechange=null,i.removeChild(e),e=null},i.appendChild(e)}):n=function(t){setTimeout(_,0,t)}:(s="setImmediate$"+Math.random()+"$",a=function(e){e.source===t&&"string"==typeof e.data&&0===e.data.indexOf(s)&&_(+e.data.slice(s.length))},t.addEventListener?t.addEventListener("message",a,!1):t.attachEvent("onmessage",a),n=function(e){t.postMessage(s+e,"*")}),l.setImmediate=function(t){"function"!=typeof t&&(t=new Function(""+t));for(var e=new Array(arguments.length-1),r=0;r<e.length;r++)e[r]=arguments[r+1];var i={callback:t,args:e};return c[u]=i,n(u),u++},l.clearImmediate=p}function p(t){delete c[t]}function _(t){if(f)setTimeout(_,0,t);else{var e=c[t];if(e){f=!0;try{!function(t){var e=t.callback,n=t.args;switch(n.length){case 0:e();break;case 1:e(n[0]);break;case 2:e(n[0],n[1]);break;case 3:e(n[0],n[1],n[2]);break;default:e.apply(r,n)}}(e)}finally{p(t),f=!1}}}}}("undefined"==typeof self?void 0===t?void 0:t:self)}).call(this,r(1),r(9))},function(t,e,r){"use strict";var n,i,o=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(t){if(n===setTimeout)return setTimeout(t,0);if((n===s||!n)&&setTimeout)return n=setTimeout,setTimeout(t,0);try{return n(t,0)}catch(e){try{return n.call(null,t,0)}catch(e){return n.call(this,t,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:s}catch(t){n=s}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(t){i=a}}();var c,f=[],h=!1,l=-1;function p(){h&&c&&(h=!1,c.length?f=c.concat(f):l=-1,f.length&&_())}function _(){if(!h){var t=u(p);h=!0;for(var e=f.length;e;){for(c=f,f=[];++l<e;)c&&c[l].run();l=-1,e=f.length}c=null,h=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===a||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function y(t,e){this.fun=t,this.array=e}function d(){}o.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];f.push(new y(t,e)),1!==f.length||h||u(_)},y.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=d,o.addListener=d,o.once=d,o.off=d,o.removeListener=d,o.removeAllListeners=d,o.emit=d,o.prependListener=d,o.prependOnceListener=d,o.listeners=function(t){return[]},o.binding=function(t){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(t){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(t,e,r){"use strict";r.r(e);var n=function(){function t(t,e,r){this._x=t,this._y=e,this._z=r}return Object.defineProperty(t.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._z},enumerable:!0,configurable:!0}),t.prototype.add=function(t){return this._x+=t.x,this._y+=t.y,this._z+=t.z,this},t.prototype.sub=function(t){return this._x-=t.x,this._y-=t.y,this._z-=t.z,this},t.prototype.unit=function(){return 0===this.mag()?this:(this.div(this.mag()),this)},t.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.prototype.mult=function(t){return this._x*=t,this._y*=t,this._z*=t,this},t.prototype.multVector=function(t){return t.x*this._x+t.y*this._y+t.z*this._z},t.prototype.div=function(t){return this._x/=t,this._y/=t,this._z/=t,this},t.prototype.clone=function(){return new t(this._x,this._y,this._z)},t.prototype.toArray=function(){return[this.x,this.y]},t.prototype.reverse=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this},t}(),i=!1,o=function(){function t(){this._destroyed=!1}return Object.defineProperty(t.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isInEventTime",{get:function(){return i},set:function(t){i=t},enumerable:!0,configurable:!0}),t.prototype.on=function(t,e){return this._listeners=this._listeners||{},this._listeners[t]=this._listeners[t]||[],this._listeners[t].push(e),this},t.prototype.once=function(t,e){return this._oneTimeListeners=this._oneTimeListeners||{},this._oneTimeListeners[t]=this._oneTimeListeners[t]||[],this._oneTimeListeners[t].push(e),this},t.prototype.off=function(t,e){return this._removeEventListener(t,e,this._listeners),this._removeEventListener(t,e,this._oneTimeListeners),this},t.prototype.emit=function(t){if(this._listeners&&this._listeners[t.type]&&this._listeners[t.type].length>0)for(var e=0,r=this._listeners[t.type].slice();e<r.length;e++){(o=r[e]).call(this,t)}if(this._oneTimeListeners&&this._oneTimeListeners[t.type]&&this._oneTimeListeners[t.type].length>0)for(var n=0,i=this._oneTimeListeners[t.type].slice();n<i.length;n++){var o=i[n];this.off(t.type,o),o.call(this,t)}return this._parent&&this._parent.emit(t),this},t.prototype.setParent=function(t){this._parent=t},t.prototype.destroy=function(){this._listeners={},this._oneTimeListeners={},this._parent=null,this._destroyed=!0},t.prototype._removeEventListener=function(t,e,r){if(r&&r[t]){var n=r[t].indexOf(e);-1!==n&&r[t].splice(n,1)}},t}(),s=function(){function t(t){this._value=t}return Object.defineProperty(t.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"before",{get:function(){return this._before.value},set:function(e){new t(e).nextLink=this},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"next",{get:function(){return this._next.value},set:function(e){new t(e).beforeLink=this},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"beforeLink",{get:function(){return this._before},set:function(t){this._before=t,t&&t.nextLink!==this&&(t.nextLink=this)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nextLink",{get:function(){return this._next},set:function(t){this._next=t,t&&t.nextLink!==this&&(t.beforeLink=this)},enumerable:!0,configurable:!0}),t.prototype.destroy=function(){this._before&&(this._before.nextLink=this._next),this._next&&(this._next.beforeLink=this._before),this._value=null,this._before=void 0,this._next=void 0},t}(),a=r(0);var u=0;var c={},f={};function h(t){Object.keys(c).forEach(function(e){t===c[e]&&(c[e]=t.beforeLink||t.nextLink,c[e]||Object(a.clearTimeout)(f[e]))}),t.destroy()}var l,p,_=1e7,y=function(){function t(t,e){void 0===e&&(e={}),this._type=t,this._data=e}return Object.defineProperty(t.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),t}(),d=(l=function(t,e){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});!function(t){t.Destroy="del",t.Happen="hal"}(p||(p={}));var m,b=function(t){function e(){return t.call(this)||this}return d(e,t),Object.defineProperty(e.prototype,"from",{get:function(){return this._from},set:function(t){this._from=t},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this.emit(new y(p.Destroy,this)),this._from=null,t.prototype.destroy.call(this)},e}(o),v=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),g=function(t){function e(e,r){var n=t.call(this)||this;return n._leftTop=e,n._rightBottom=r,n}return v(e,t),Object.defineProperty(e.prototype,"center",{get:function(){return this.lt.clone().add(this.rb).div(2)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.rb.x-this.lt.x},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.rb.y-this.lt.y},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lt",{get:function(){return this._leftTop},set:function(t){this._leftTop=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rb",{get:function(){return this._rightBottom},set:function(t){this._rightBottom=t},enumerable:!0,configurable:!0}),e.prototype.intersect=function(t){return t instanceof e&&this._intersectBox(t)},e.prototype._intersectBox=function(t){var e=Math.abs(t.center.x-this.center.x),r=Math.abs(t.center.y-this.center.y),n=(this.width+t.width)/2,i=(this.height+t.height)/2;return e<=n&&r<=i},e}(b),x=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),w=function(t){function e(e){var r=t.call(this)||this;r._speed=new n(0,0,0),r._direction=new n(1,0,0),r._color=[0,0,0,255],r._size=1,r._lifePoint=_;var i=e.loc,o=e.speed,s=e.color,a=e.size,c=void 0===a?r._size:a,f=e.lifePoint;return r._loc=i,r._speed=o||r._speed,r._color=s||r._color,r._size=c||r._size,r._lifePoint=f||r._lifePoint,r._lastUpdateTime=Date.now(),r._id=u++,r._regCollsion(),r}return x(e,t),e.prototype.update=function(){},Object.defineProperty(e.prototype,"collsionType",{get:function(){return this._collsionUnitType},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"collsionUnit",{get:function(){return this._collsionUnit},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"loc",{get:function(){return this._loc},set:function(t){this._loc=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"direction",{get:function(){return this._direction},set:function(t){this._direction=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"speed",{get:function(){return this._speed},set:function(t){this._speed=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastUpdateTime",{get:function(){return this._lastUpdateTime},enumerable:!0,configurable:!0}),e.prototype.updateLocation=function(){var t=Date.now(),e=t-this._lastUpdateTime;this._lastUpdateTime=t;var r=this._speed.clone().mult(e);this._loc=this._loc.add(r),this._collsionUnit&&this.updateCollsionUnit()},e.prototype.updateCollsionUnit=function(){var t=this._getCollsionPoint();this._collsionUnit.lt=this._loc.clone().sub(t),this._collsionUnit.rb=this._loc.clone().add(t)},e.prototype.destroy=function(){this._collsionUnit.destroy(),t.prototype.destroy.call(this)},e.prototype._getCollsionPoint=function(){var t=this._size/2;return new n(t,t,0)},e.prototype._regCollsion=function(){var t=this._getCollsionPoint();this._collsionUnit=new g(this._loc.clone().sub(t),this._loc.clone().add(t)),this._collsionUnit.from=this},e}(o),A=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();!function(t){t[t.Bullet=0]="Bullet",t[t.Shooter=1]="Shooter",t[t.Grid=2]="Grid",t[t.Border=3]="Border"}(m||(m={}));var O=function(t){function e(){return t.call(this)||this}return A(e,t),e.prototype.clear=function(){this._collsionMap={}},e.prototype.addCollsionUnit=function(t,e){var r=this,n=e.collisionTypes,i=new s(t),o=t.from.collsionType;this._collsionMap[o]&&(this._collsionMap[o].nextLink=i),this._collsionMap[o]=i;var a,u=!1;t.on(p.Destroy,a=function(){u=!0,i.destroy()}),n.forEach(function(e){for(var n=r._collsionMap[e];n;){if(u)return;if(!n.value)return;if(n.value.destroyed)return;n.value.intersect(t)&&(n.value.emit(new y(p.Happen,t)),t.emit(new y(p.Happen,n.value))),n=n.beforeLink}}),u||t.off(p.Destroy,a)},e}(o),P=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),M="del",L=function(t){function e(e){var r=t.call(this,e)||this;return r._lifeTime=5e3,r._collsionUnitType=m.Bullet,r._baseDamage=2,r.direction=r.speed.clone().unit(),r._baseDamage=e.damage||r._baseDamage,r._lifeEndTimeout=setTimeout(function(){r.destroy()},r._lifeTime),r._registEvent(),r}return P(e,t),e.prototype.getDamage=function(t){var e=this.speed.mag(),r=e+this.speed.clone().unit().multVector(t.speed);return r<=0?0:0===this.speed.mag()?0:(r=r>e?1.51*e:.67*e,Math.max(Math.round(r/e*this._baseDamage),1))},Object.defineProperty(e.prototype,"owner",{get:function(){return this._owner},set:function(t){this._owner=t},enumerable:!0,configurable:!0}),e.prototype.addCollsionBullet=function(t){t.addCollsionUnit(this._collsionUnit,{collisionTypes:[m.Shooter,m.Border]})},e.prototype.destroy=function(){clearTimeout(this._lifeEndTimeout),this._owner=null,this.emit(new y(M,this)),t.prototype.destroy.call(this)},e.prototype._registEvent=function(){var t=this;this._collsionUnit.on(p.Happen,function(e){e.data.from.collsionType===m.Border&&t._borderCollsion()})},e.prototype._borderCollsion=function(){this.destroy()},e}(w),B=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),j=function(t){function e(){var e=t.call(this)||this;return e._bulletNum=0,e}return B(e,t),e.prototype.addBullet=function(t){var e=this;this._bulletNum++;var r=new L(t),n=new s(r);return this._bulletLink&&(n.beforeLink=this._bulletLink),this._bulletLink=n,r.once(M,function(){e._bulletLink===n&&(e._bulletLink=n.nextLink||n.beforeLink),n.destroy(),e._bulletNum--}),r},e.prototype.addCollsionUnit=function(t){this.forEach(function(e){e.addCollsionBullet(t)})},Object.defineProperty(e.prototype,"bulletNum",{get:function(){return this._bulletNum},enumerable:!0,configurable:!0}),e.prototype.forEach=function(t){if(this._bulletLink)for(var e=this._bulletLink;e;)t(e.value),e=e.beforeLink},e.prototype.destroy=function(){this.forEach(function(t){t.destroy()}),t.prototype.destroy.call(this)},e.prototype.update=function(){this.forEach(function(t){t.updateLocation()})},e}(o),T=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),V=function(t){function e(e){var r=t.call(this,e)||this;r._defaultDecSpeed=.04,r._maxFirePerSec=3,r._minFireTime=1e3/3,r._lastFireTime=0,r._bulletSpeed=.3,r._bulletManager=new j,r._bulletColor=[255,153,17,255],r._bulletSize=6,r._collsionUnitType=m.Shooter;var n=e.uid;e.camp;return r._uid=n,r.size=10,r._camp=e.camp,r._bulletManager.setParent(r),r._registEvent(),r}return T(e,t),Object.defineProperty(e.prototype,"bulletSize",{set:function(t){this._bulletSize=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bulletColor",{set:function(t){this._bulletColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bulletSpeed",{set:function(t){this._bulletSpeed=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxFirePerSec",{set:function(t){this._maxFirePerSec=t,this._minFireTime=1e3/t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"camp",{get:function(){return this._camp},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this._uid},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bulletManager",{get:function(){return this._bulletManager},enumerable:!0,configurable:!0}),e.prototype.addCollsionUnit=function(t){t.addCollsionUnit(this._collsionUnit,{collisionTypes:[m.Border,m.Bullet]}),this._bulletManager.addCollsionUnit(t)},e.prototype.update=function(){this._lastLoc=this.loc.clone(),this.updateLocation(),0!==this.speed.mag()&&this.speed.sub(this.speed.clone().mult(this._defaultDecSpeed)),this._bulletManager.update()},e.prototype.startFire=function(){var t=this,e=Date.now();return!(e-this._lastFireTime<this._minFireTime)&&(this._setIntervalFire&&h(this._setIntervalFire),this._lastFireTime=e,this.fire(),this._setIntervalFire=function(t,e){e=Math.floor(e);var r=new s(t);return c[e]?(r.beforeLink=c[e],c[e]=r,r):(c[e]=r,f[e]=Object(a.setInterval)(function(){for(var t=c[e];t;)t.value(),0,t=t.beforeLink},e),r)}(function(){t.fire()},this._minFireTime),!0)},e.prototype.endFire=function(){this._setIntervalFire&&h(this._setIntervalFire)},e.prototype.destroy=function(){this._collsionUnit.destroy(),this._bulletManager.destroy(),t.prototype.destroy.call(this)},e.prototype.fire=function(){this.direction.clone().mult(this._bulletSpeed),this.direction.clone().mult(this.direction.multVector(this.speed));this._bulletManager.addBullet({loc:this.loc.clone(),speed:this.direction.clone().mult(this._bulletSpeed).add(this.speed),color:this._bulletColor,size:this._bulletSize}).owner=this},e.prototype._judgeEnemyBullet=function(t){var e=t.from.owner.camp;return this._camp!==e},e.prototype._registEvent=function(){var t=this;this._collsionUnit.on(p.Happen,function(e){var r=e.data,n=r.from.collsionType;n===m.Border?t._borderCollision():n===m.Bullet&&t._bulletCollsion(r)})},e.prototype._bulletCollsion=function(t){if(this._judgeEnemyBullet(t)){var e=t.from;this.speed.add(e.speed.mult(e.size/this.size)),this._getBulletDamage(e)}},e.prototype._getBulletDamage=function(t){var e=t.getDamage(this);console.log("cause damage",e),0!==e&&(this._getDamage(e),t.destroy())},e.prototype._getDamage=function(t){var e=this;this._lifePoint-=t,console.log(this.id,"left life point",this._lifePoint),this._lifePoint<=0?this.destroy():(this._originColor||(this._originColor=this.color),this.color=[255,0,0,255],setTimeout(function(){e.color=e._originColor},1e3))},e.prototype._borderCollision=function(){this.loc=this._lastLoc,this.speed=new n(0,0,0)},e}(w),S=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),E={MOVE:"mousemove",DOWN:"mousedown",UP:"mouseup"},F=function(t){function e(e,r){var n=t.call(this)||this;return n._element=e,n._camera=r,document.addEventListener(E.MOVE,n._onMouseMove.bind(n)),document.addEventListener(E.DOWN,n._onMouseDown.bind(n)),document.addEventListener(E.UP,n._onMouseUp.bind(n)),n}return S(e,t),e.prototype.init=function(t){this._camera=t},e.prototype._onMouseMove=function(t){var e=this._getMouseCoordinate(t);this.emit(new y(E.MOVE,e))},e.prototype._onMouseDown=function(t){var e=this._getMouseCoordinate(t);this.emit(new y(E.DOWN,e))},e.prototype._onMouseUp=function(t){var e=this._getMouseCoordinate(t);this.emit(new y(E.UP,e))},e.prototype._getMouseCoordinate=function(t){var e=new n(t.clientX,t.clientY,0);return this._camera.pixelToCoordinate(e)},e}(o),C=function(){function t(t){var e=t.secret,r=t.id,n=t.camera,i=t.keyboard,o=t.mouse;this._keyboard=i,this._mouse=o,this._secret=e,this._id=r,this._camera=n,this._bindKeyboard(),this._bindMouse()}return Object.defineProperty(t.prototype,"loc",{get:function(){return this._shooter.loc},set:function(t){this._shooter.loc=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"camera",{get:function(){return this._camera},set:function(t){this._camera=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shooter",{get:function(){return this._shooter},enumerable:!0,configurable:!0}),t.prototype.fitCamera=function(){this._camera.setLoc(this._shooter.loc)},t.prototype.createShooter=function(t){return this._shooter=new V({loc:t,uid:this._id,camp:0}),this._shooter},t.prototype._bindMouse=function(){var t=this;if(!this._mouse)return!1;this._bindMouseDown(),this._mouse.on(E.MOVE,function(e){e.data;var r=e.data.sub(t._shooter.loc);t._shooter.direction=r.unit()})},t.prototype._bindMouseDown=function(){var t=this;this._mouse.once(E.DOWN,function(){t._shooter.startFire(),t._mouse.once(E.UP,function(){t._shooter.endFire(),t._bindMouseDown()})})},t.prototype._bindKeyboard=function(){var t=this;if(!this._keyboard)return!1;this._keyboard.on("change_speed",function(e){t.shooter.speed.add(e)})},t}(),U=function(){},I=function(){function t(t,e,r){this._padding=1,this._loc=t,this._width=e,this._color=r}return Object.defineProperty(t.prototype,"loc",{get:function(){return this._loc},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return new n(this._loc.x*this._width+this._width/2,this._loc.y*this._width+this._width/2,this._loc.z)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"padding",{get:function(){return this._padding},enumerable:!0,configurable:!0}),t}();var D=function(){function t(t,e,r,n,i,o){void 0===o&&(o=!0),this.isStatic=!0,this._type=r,this._arrayBuffer=e,this._elementBytes=n,this._attributes=i,this.gl=t,this.isStatic=o}return Object.defineProperty(t.prototype,"elementBytes",{get:function(){return this._elementBytes},set:function(t){this._elementBytes=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"attributes",{get:function(){return this._attributes},set:function(t){this._attributes=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arrayBuffer",{get:function(){return this._arrayBuffer},set:function(t){this._arrayBuffer=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){var t=0;return this._arrayBuffer&&(t+=this._arrayBuffer.byteLength/1024/1024),t},enumerable:!0,configurable:!0}),t.prototype.bind=function(){this._buffer?this.gl.bindBuffer(this.gl[this._type],this._buffer):(this._buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl[this._type],this._buffer),this.gl.bufferData(this.gl[this._type],this._arrayBuffer,this.isStatic?this.gl.STATIC_DRAW:this.gl.DYNAMIC_DRAW))},t.prototype.updateData=function(t){this._arrayBuffer=t,this._buffer?(this.gl.bindBuffer(this.gl[this._type],this._buffer),this._arrayBuffer&&this._arrayBuffer.byteLength>=t.byteLength?this.gl.bufferSubData(this.gl[this._type],0,t):this.gl.bufferData(this.gl[this._type],t,this.isStatic?this.gl.STATIC_DRAW:this.gl.DYNAMIC_DRAW)):(this._buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl[this._type],this._buffer),this.gl.bufferData(this.gl[this._type],t,this.isStatic?this.gl.STATIC_DRAW:this.gl.DYNAMIC_DRAW))},t.prototype.destroy=function(){this._buffer&&(this.gl.deleteBuffer(this._buffer),this._buffer=null)},t}(),k=function(){function t(t){this._renderer=t,this._gl=this._renderer.gl}return t.prototype.draw=function(t){if(this.update(),this._vertexArray.byteLength){this._renderer.useProgram(this._program),this._program.bindNoCachedMatrix(this._gl,new Float32Array(t));for(var e=this._createGLBufferGroup(),r=0,n=this._segments;r<n.length;r++){var i=n[r];this._program.bindVAO(this._gl,e,i),this._program.draw(this._gl,i)}}},Object.defineProperty(t.prototype,"uint32VertexArray",{get:function(){return this._uint32VertexArray||(this._uint32VertexArray=new Uint32Array(this._vertexArray)),this._uint32VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uint16VertexArray",{get:function(){return this._uint16VertexArray||(this._uint16VertexArray=new Uint16Array(this._vertexArray)),this._uint16VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uint8VertexArray",{get:function(){return this._uint8VertexArray||(this._uint8VertexArray=new Uint8Array(this._vertexArray)),this._uint8VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"int32VertexArray",{get:function(){return this._int32VertexArray||(this._int32VertexArray=new Int32Array(this._vertexArray)),this._int32VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"int16VertexArray",{get:function(){return this._int16VertexArray||(this._int16VertexArray=new Int16Array(this._vertexArray)),this._int16VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"int8VertexArray",{get:function(){return this._int8VertexArray||(this._int8VertexArray=new Int8Array(this._vertexArray)),this._int8VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"float32VertexArray",{get:function(){return this._float32VertexArray||(this._float32VertexArray=new Float32Array(this._vertexArray)),this._float32VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"float64VertexArray",{get:function(){return this._float64VertexArray||(this._float64VertexArray=new Float64Array(this._vertexArray)),this._float64VertexArray},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vertexArray",{set:function(t){this._vertexArray=t,this._uint32VertexArray=null,this._uint16VertexArray=null,this._uint8VertexArray=null,this._int32VertexArray=null,this._int16VertexArray=null,this._int8VertexArray=null,this._float32VertexArray=null,this._float64VertexArray=null},enumerable:!0,configurable:!0}),t.prototype._createSegment=function(){return{primitiveLength:0,primitiveOffset:0,vertexLength:0,vertexOffset:0}},t.prototype._initProgram=function(){if(this._renderer.createProgram(this._programType),this._program=this._renderer.getCachedProgram(this._programType),!this._program)throw new Error("no "+this._programType+" program")},t}(),z=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),R=function(t){function e(e){var r=t.call(this,e)||this;return r._shooters=[],r._vertexBufferByteSize=20,r._programType="circle",r._initProgram(),r}return z(e,t),Object.defineProperty(e.prototype,"shooters",{get:function(){return this._shooters},enumerable:!0,configurable:!0}),e.prototype.addShooter=function(t){this._shooters.push(t)},e.prototype.update=function(){var t=this,e=this._createSegment(),r=this._shooters.length+1;this.vertexArray=new ArrayBuffer(this._vertexBufferByteSize*r*4),this._elementArray=new Uint16Array(6*r),this._shooters.forEach(function(e,r){e.destroyed||t._resolveShooter(e,r)}),e.vertexLength=4*r,e.primitiveLength=2*r,this._segments=[e]},e.prototype._createGLBufferGroup=function(){var t=[];return t.push({name:"a_pos",type:"FLOAT",components:3,offset:0}),t.push({name:"a_infos",type:"FLOAT",components:1,offset:12}),t.push({name:"a_color",type:"UNSIGNED_BYTE",components:4,offset:16}),{vertexLayoutArrayBuffer:new D(this._gl,this._vertexArray,"ARRAY_BUFFER",20,t),elementArrayBuffer:new D(this._gl,this._elementArray.buffer,"ELEMENT_ARRAY_BUFFER",6,[{components:3,name:"vertices",offset:0,type:"UNSIGNED_SHORT"}]),paintVertexArrayBuffer:null,segments:this._segments}},e.prototype._resolveShooter=function(t,e){var r=e;e*=4,this._resolveVeretx(t,e,0,1),this._resolveVeretx(t,e+1,1,1),this._resolveVeretx(t,e+2,1,0),this._resolveVeretx(t,e+3,0,0);var n=6*r;this._elementArray[n++]=e,this._elementArray[n++]=e+1,this._elementArray[n++]=e+2,this._elementArray[n++]=e,this._elementArray[n++]=e+2,this._elementArray[n++]=e+3},e.prototype._resolveVeretx=function(t,e,r,n){var i=e*this._vertexBufferByteSize/4,o=e*this._vertexBufferByteSize,s=t.loc.x,a=t.loc.y,u=t.loc.z,c=t.color,f=t.size;this.float32VertexArray[i]=s,this.float32VertexArray[i+1]=a,this.float32VertexArray[i+2]=u;var h=2*(2*f+r)+n;this.float32VertexArray[i+3]=h,this.uint8VertexArray[o+16]=c[0],this.uint8VertexArray[o+17]=c[1],this.uint8VertexArray[o+18]=c[2],this.uint8VertexArray[o+19]=c[3]},e}(k),N=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),G=function(t){function e(e){var r=t.call(this,e)||this;return r._height=e.height,r._width=e.width,r}return N(e,t),e.prototype._getCollsionPoint=function(){var t=this._width/2,e=this._height/2;return new n(t,e,0)},e}(w),W=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Y=function(t){function e(e){var r=t.call(this,e)||this;return r._collsionUnitType=m.Border,r.updateLocation(),r}return W(e,t),Object.defineProperty(e.prototype,"collisionUnit",{get:function(){return this._collsionUnit},enumerable:!0,configurable:!0}),e}(G),H=1e5,X=function(){function t(t,e,r){this._borderWidth=H,this._borders=[],this._width=t*r,this._height=e*r,this._gridSize=r,this.initBorders()}return t.prototype._getCollsionPoint=function(){var t=this._width/2,e=this._height/2;return new n(t,e,0)},t.prototype.addCollsionUnit=function(t){this._borders.forEach(function(e){t.addCollsionUnit(e.collisionUnit,{collisionTypes:[m.Bullet,m.Shooter]})})},t.prototype.inBorder=function(t){return!(t.x<-this._width/2||t.x>this._width/2)&&(!(t.y<-this._height/2||t.y>this._height/2)&&void 0)},t.prototype.initBorders=function(){var t=this._borderWidth/2;this._topBorder=new Y({loc:new n(0,-this._height/2-t,0),height:this._borderWidth,width:this._width}),this._borders.push(this._topBorder),this._rightBorder=new Y({loc:new n(this._width/2+t,0,0),height:this._height,width:this._borderWidth}),this._borders.push(this._rightBorder),this._leftBorder=new Y({loc:new n(-this._width/2-t,0,0),height:this._height,width:this._borderWidth}),this._borders.push(this._leftBorder),this._bottomBorder=new Y({loc:new n(0,this._height/2+t,0),height:this._borderWidth,width:this._width}),this._borders.push(this._bottomBorder)},t}(),q=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Z=function(t){function e(e){var r=t.call(this,e)||this;return r._grids=[],r._programType="triangle",r._vertexBufferByteSize=20,r._initProgram(),r}return q(e,t),e.prototype.addGrid=function(t){this._grids.push(t)},e.prototype.getGrid=function(t){return this._grids[t]},e.prototype.update=function(){var t=this,e=this._createSegment();this.vertexArray=new ArrayBuffer(this._vertexBufferByteSize*this._grids.length*4),this._elementArray=new Uint16Array(6*this._grids.length),this._grids.forEach(function(e,r){t._resolveGrid(e,r)}),e.vertexLength=4*this._grids.length,e.primitiveLength=2*this._grids.length,this._segments=[e]},e.prototype._createGLBufferGroup=function(){var t=[];return t.push({name:"a_pos",type:"FLOAT",components:3,offset:0}),t.push({name:"a_infos",type:"FLOAT",components:1,offset:12}),t.push({name:"a_color",type:"UNSIGNED_BYTE",components:4,offset:16}),{vertexLayoutArrayBuffer:new D(this._gl,this._vertexArray,"ARRAY_BUFFER",20,t),elementArrayBuffer:new D(this._gl,this._elementArray.buffer,"ELEMENT_ARRAY_BUFFER",6,[{components:3,name:"vertices",offset:0,type:"UNSIGNED_SHORT"}]),paintVertexArrayBuffer:null,segments:this._segments}},e.prototype._resolveGrid=function(t,e){var r=e;e*=4,this._resolveVeretx(t,e,0,1),this._resolveVeretx(t,e+1,1,1),this._resolveVeretx(t,e+2,1,0),this._resolveVeretx(t,e+3,0,0);var n=6*r;this._elementArray[n++]=e,this._elementArray[n++]=e+1,this._elementArray[n++]=e+2,this._elementArray[n++]=e,this._elementArray[n++]=e+2,this._elementArray[n++]=e+3},e.prototype._resolveVeretx=function(t,e,r,n){var i=e*this._vertexBufferByteSize/4,o=e*this._vertexBufferByteSize,s=t.center.x,a=t.center.y,u=t.center.z,c=t.color,f=t.width-2*t.padding;this.float32VertexArray[i]=s,this.float32VertexArray[i+1]=a,this.float32VertexArray[i+2]=u;var h=2*(2*f+r)+n;this.float32VertexArray[i+3]=h,this.uint8VertexArray[o+16]=c[0],this.uint8VertexArray[o+17]=c[1],this.uint8VertexArray[o+18]=c[2],this.uint8VertexArray[o+19]=c[3]},e}(k),K=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),$=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return K(e,t),e}(n),J=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Q=function(t){function e(e){var r=t.call(this,e)||this;return r._bulletManagers=[],r._vertexBufferByteSize=20,r._programType="triangle",r._initProgram(),r}return J(e,t),e.prototype.addBulletManager=function(t){this._bulletManagers.push(t.bulletManager)},e.prototype.update=function(){var t=this,e=this._createSegment(),r=0;this._bulletManagers.forEach(function(t){r+=t.bulletNum}),this.vertexArray=new ArrayBuffer(4*r*this._vertexBufferByteSize),this._elementArray=new Uint16Array(6*r);var n=0;this._bulletManagers.forEach(function(e){e.forEach(function(e){t._resolveBullet(e,n),n++})}),e.vertexLength=4*r,e.primitiveLength=2*r,this._segments=[e]},e.prototype._createGLBufferGroup=function(){var t=[];return t.push({name:"a_pos",type:"FLOAT",components:3,offset:0}),t.push({name:"a_infos",type:"FLOAT",components:1,offset:12}),t.push({name:"a_color",type:"UNSIGNED_BYTE",components:4,offset:16}),{vertexLayoutArrayBuffer:new D(this._gl,this._vertexArray,"ARRAY_BUFFER",20,t),elementArrayBuffer:new D(this._gl,this._elementArray.buffer,"ELEMENT_ARRAY_BUFFER",6,[{components:3,name:"vertices",offset:0,type:"UNSIGNED_SHORT"}]),paintVertexArrayBuffer:null,segments:this._segments}},e.prototype._resolveBullet=function(t,e){var r=e;e*=4,this._resolveVeretx(t,e,0,1),this._resolveVeretx(t,e+1,1,1),this._resolveVeretx(t,e+2,1,0),this._resolveVeretx(t,e+3,0,0);var n=6*r;this._elementArray[n++]=e,this._elementArray[n++]=e+1,this._elementArray[n++]=e+2,this._elementArray[n++]=e,this._elementArray[n++]=e+2,this._elementArray[n++]=e+3},e.prototype._resolveVeretx=function(t,e,r,n){var i=e*this._vertexBufferByteSize/4,o=e*this._vertexBufferByteSize,s=t.loc.x,a=t.loc.y,u=t.loc.z,c=t.color,f=t.size;this.float32VertexArray[i]=s,this.float32VertexArray[i+1]=a,this.float32VertexArray[i+2]=u;var h=2*(2*f+r)+n;this.float32VertexArray[i+3]=h,this.uint8VertexArray[o+16]=c[0],this.uint8VertexArray[o+17]=c[1],this.uint8VertexArray[o+18]=c[2],this.uint8VertexArray[o+19]=c[3]},e}(k),tt=0;var et,rt=function(){function t(t){this._hateElement=t.hate}return t.prototype.update=function(){this._ai.update()},t.prototype.destroy=function(){this._ai.destroy(),this._me.destroy()},t}(),nt=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();!function(t){t[t.Wait=0]="Wait",t[t.Search=1]="Search",t[t.Attack=2]="Attack"}(et||(et={}));var it,ot=function(t){function e(){var e=t.call(this)||this;return e._actionMode=et.Wait,e}return nt(e,t),Object.defineProperty(e.prototype,"myObj",{set:function(t){this._myObj=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"targetObj",{set:function(t){this._targetObj=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"actionMode",{set:function(t){this._actionMode=t},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this._myObj=null,this._targetObj=null,t.prototype.destroy.call(this)},e}(o),st=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();!function(t){t.ChangeSpeed="cs",t.Fire="f",t.EndFire="ef"}(it||(it={}));var at=function(t){function e(e){var r=t.call(this)||this;return r._attackToleranceDistance=400,r._searchToleranceDistance=600,r._attackMaxDistance=200,r}return st(e,t),e.prototype.update=function(){var t=this._myObj.loc.clone().sub(this._targetObj.loc).mag();t>=600?this._startWait():t>=400?this._startSearch():this._startAttack(t)},e.prototype._startSearch=function(){this.emit(new y(it.EndFire));var t=this._targetObj.loc.clone().sub(this._myObj.loc);this.emit(new y(it.ChangeSpeed,t.unit().mult(.003)))},e.prototype._startWait=function(){this.emit(new y(it.EndFire)),this._randomMove()},e.prototype._randomMove=function(){var t=this;this._waitVector?this.emit(new y(it.ChangeSpeed,this._waitVector)):(this._waitVector=new n(Math.random()-.5,Math.random()-.5,0).unit().mult(.003),setTimeout(function(){t._waitVector=null},2e3))},e.prototype._startAttack=function(t){var e=this._targetObj.loc.clone().sub(this._myObj.loc);t>=200?this._randomMove():this.emit(new y(it.ChangeSpeed,e.clone().unit().reverse().mult(.003))),this.emit(new y(it.Fire,e))},e}(ot),ut=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),ct=function(t){function e(e){var r=t.call(this,e)||this;return r._maxFirePerSec=1,r._bulletColor=[255,99,71,255],r._bulletSize=8,r._camp=1,r._bulletSpeed=.06,r._selfColor=[255,250,205,255],r._onFire=!1,r}return ut(e,t),e.prototype.createTrashFish=function(t){var e;return this._me=new V({loc:t,uid:(e="Enemy_"+tt,tt++,e),camp:this._camp,lifePoint:10}),this._me.maxFirePerSec=this._maxFirePerSec,this._me.bulletColor=this._bulletColor,this._me.bulletSize=this._bulletSize,this._me.bulletSpeed=this._bulletSpeed,this._me.color=this._selfColor,this._initAi(),this._me},Object.defineProperty(e.prototype,"trashFish",{get:function(){return this._me},enumerable:!0,configurable:!0}),e.prototype._initAi=function(){this._ai=new at({}),this._ai.myObj=this._me,this._ai.targetObj=this._hateElement,this._initEvent()},e.prototype._initEvent=function(){var t=this;this._ai.on(it.ChangeSpeed,function(e){t._me.speed.add(e.data)}),this._ai.on(it.Fire,function(e){t._me.direction=e.data.unit(),t._onFire||(t._onFire=t._me.startFire())}),this._ai.on(it.EndFire,function(){t._onFire=!1,t._me.endFire()})},e}(rt),ft=function(){function t(t,e,r){this._gridSize=50,this._trashFishs=[],this._width=t,this._height=e,this._dataBucket=new U,this._shooterLayer=new R(r),this._bulletLayer=new Q(r),this._gridLayer=new Z(r),this._border=new X(t,e,this._gridSize),this._collisonManager=new O,this._initGrids()}return t.prototype.update=function(){this._trashFishs.forEach(function(t){t.update()}),this._shooterLayer.shooters.forEach(function(t){t.destroyed||t.update()})},t.prototype.globalCollsion=function(){var t=this;this._collisonManager.clear(),this._border.addCollsionUnit(this._collisonManager),this._shooterLayer.shooters.forEach(function(e){e.destroyed||e.addCollsionUnit(t._collisonManager)})},t.prototype.joinPlayer=function(t){var e=t.createShooter(new n(0,0,0));this._shooterLayer.addShooter(e),this._bulletLayer.addBulletManager(e),this._initEnemy(e)},t.prototype.setView=function(t){this._camera=t.camera,t.fitCamera()},t.prototype.draw=function(){this.update(),this.globalCollsion(),this._gridLayer.draw(this._camera.mvpMatrix),this._shooterLayer.draw(this._camera.mvpMatrix),this._bulletLayer.draw(this._camera.mvpMatrix)},t.prototype._initEnemy=function(t){for(var e=0;e<20;e++){var r=new ct({hate:t}),i=new n(Math.random()-.5,Math.random()-.5,0),o=r.createTrashFish(i.mult(1500));this._shooterLayer.addShooter(o),this._bulletLayer.addBulletManager(o),this._trashFishs.push(r)}},t.prototype._initGrids=function(){for(var t=0;t<this._width;t++)for(var e=0;e<this._height;e++){var r=t-Math.floor(this._width/2),n=e-Math.floor(this._height/2),i=new I(new $(r,n,0),this._gridSize,[0,0,0,100]);this._gridLayer.addGrid(i)}},t}(),ht=r(2),lt=r.n(ht),pt=r(3),_t=r.n(pt),yt=r(4),dt=r.n(yt),mt=r(5),bt=r.n(mt),vt={},gt={};function xt(t,e){vt[t]=e}xt("triangle_vertexSource",lt.a),xt("triangle_fragmentSource",_t.a),xt("circle_vertexSource",dt.a),xt("circle_fragmentSource",bt.a);var wt="mediump",At=function(){function t(t,e,r,n){e=this._processIncludes(e),r=this._processIncludes(r),this._defines=n,e=(n?n+"\n":"")+e,r=(n?n+"\n":"")+r,this._vertexSource=e.replace(/{precision}/,wt),this._fragmentSource=r.replace(/{precision}/,wt);var i=t.createShader(t.FRAGMENT_SHADER),o=t.createShader(t.VERTEX_SHADER);this.initVertexShader(t,o),this.initFragmentShader(t,i)}return t.prototype.attach=function(t,e){t.attachShader(e,this._vertexShader),t.attachShader(e,this._fragmentShader)},t.prototype._processIncludes=function(t){for(var e=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,r=e.exec(t),n=t;null!==r;){var i=r[1];if(gt[i]){var o=gt[i];n=n.replace(r[0],o)}else n=n.replace(r[0],""),console.warn("#inclue<"+i+"> not found in include store !");r=e.exec(t)}return n},t.prototype.initVertexShader=function(t,e){if(t.shaderSource(e,this._vertexSource),t.compileShader(e),!t.getShaderParameter(e,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(e));this._vertexShader=e},t.prototype.initFragmentShader=function(t,e){if(t.shaderSource(e,this._fragmentSource),t.compileShader(e),!t.getShaderParameter(e,t.COMPILE_STATUS))throw new Error("shader compile error: "+t.getShaderInfoLog(e));this._fragmentShader=e},Object.defineProperty(t.prototype,"vs",{get:function(){return this._vertexSource},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fs",{get:function(){return this._fragmentSource},enumerable:!0,configurable:!0}),t}(),Ot=function(){function t(t,e,r,n,i){this._uniformActiveInfosMap=null,this._lastUniformMap={},this._warningMessagMap=null,this._frames=0,this._lastCoordZoom=-1,this._lastFrameId=-1,this._typeUniformFunMap={},this._coordMatrixLocMap={},this._matrixNameCoordMap={},this._matrixArrayLength=0,this._id=null,this._type=e,this._id=e+"_"+i,this._warningMessagMap={},this._program=t.createProgram(),this._ext=t.getExtension("OES_vertex_array_object"),this._boundElementBuffer=null,this._boundPaintVertexArrayBuffer=null,this._boundLayoutVertexBuffer=null,this._attributesLocation={};var o=new At(t,r,n,i);this._attachLink(t,o),this._initAttributesLocation(t),this._updateActiveUniformInfos(t),this._uniformActiveInfosMap["u_matrix_array[0]"]&&(this._matrixArrayLength=this._uniformActiveInfosMap["u_matrix_array[0]"].size,this._updateMatrixUniformInfos(t)),this._prepareTypeUniformFunMap(t)}return Object.defineProperty(t.prototype,"lastLayerName",{get:function(){return this._lastLayerName},set:function(t){this._lastLayerName=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastFrameId",{get:function(){return this._lastFrameId},set:function(t){this._lastFrameId=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastCoordZoom",{get:function(){return this._lastCoordZoom},set:function(t){this._lastCoordZoom=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frames",{get:function(){return this._frames},set:function(t){this._frames=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype.updateFrame=function(t){this._lastFrameId!==t&&(this._lastFrameId=t,this.clearFrame())},t.prototype.use=function(t){t.useProgram(this._program)},t.prototype.bindVAO=function(t,e,r){var n=(r.vaos||(r.vaos={}))[this._id];this._ext&&n?this._ext.bindVertexArrayOES(n):this.freshBindVAO(t,e,r)},t.prototype.bindUniformMatrix=function(t,e,r,n){if(void 0===n&&(n="u_coord_id"),void 0===this._coordMatrixLocMap[e]){var i=this._getFreeMatrixUniformIndex();void 0!==i?this.storeMatrixAt(t,i,r,e,n):this.bindNoCachedMatrix(t,r,n)}else this.bindUniform(t,n,this._coordMatrixLocMap[e])},t.prototype.storeMatrixAt=function(t,e,r,n,i){var o=this._uniformActiveInfosMap["u_matrix_array["+e+"]"];this._coordMatrixLocMap[n]=e,this._matrixNameCoordMap[e]=n,this.bindUniform(t,o.name,r),this.bindUniform(t,i,e)},t.prototype.bindNoCachedMatrix=function(t,e,r){void 0===r&&(r="u_coord_id");var n=this._matrixArrayLength-1;this.bindUniform(t,"u_matrix_array["+n+"]",e),this.bindUniform(t,r,n)},t.prototype.getAttributesLoaction=function(){return this._attributesLocation},t.prototype.clearFrame=function(){this._coordMatrixLocMap={},this._matrixNameCoordMap={}},t.prototype._getFreeMatrixUniformIndex=function(){for(var t=0;t<this._matrixArrayLength-1;t++)if(void 0===this._matrixNameCoordMap[t])return t},t.prototype._prepareTypeUniformFunMap=function(t){this._typeUniformFunMap[t.FLOAT]=t.uniform1f.bind(t),this._typeUniformFunMap[t.FLOAT+"_ARRAY"]=t.uniform1fv.bind(t),this._typeUniformFunMap[t.FLOAT_VEC2]=t.uniform2fv.bind(t),this._typeUniformFunMap[t.FLOAT_VEC3]=t.uniform3fv.bind(t),this._typeUniformFunMap[t.FLOAT_VEC4]=t.uniform4fv.bind(t),this._typeUniformFunMap[t.FLOAT_MAT2]=function(e,r){return t.uniformMatrix2fv(e,!1,r)},this._typeUniformFunMap[t.FLOAT_MAT3]=function(e,r){return t.uniformMatrix3fv(e,!1,r)},this._typeUniformFunMap[t.FLOAT_MAT4]=function(e,r){return t.uniformMatrix4fv(e,!1,r)},this._typeUniformFunMap[t.INT]=t.uniform1i.bind(t),this._typeUniformFunMap[t.INT+"_ARRAY"]=t.uniform1iv.bind(t),this._typeUniformFunMap[t.INT_VEC2]=t.uniform2iv.bind(t),this._typeUniformFunMap[t.INT_VEC3]=t.uniform3iv.bind(t),this._typeUniformFunMap[t.INT_VEC4]=t.uniform4iv.bind(t),this._typeUniformFunMap[t.BOOL]=t.uniform1i.bind(t),this._typeUniformFunMap[t.BOOL+"_ARRAY"]=t.uniform1iv.bind(t),this._typeUniformFunMap[t.BOOL_VEC2]=t.uniform2iv.bind(t),this._typeUniformFunMap[t.BOOL_VEC3]=t.uniform3iv.bind(t),this._typeUniformFunMap[t.BOOL_VEC4]=t.uniform4iv.bind(t),this._typeUniformFunMap[t.SAMPLER_2D]=t.uniform1i.bind(t),this._typeUniformFunMap[t.SAMPLER_CUBE]=t.uniform1i.bind(t)},t.prototype._attachLink=function(t,e){if(e.attach(t,this._program),t.linkProgram(this._program),!t.getProgramParameter(this._program,t.LINK_STATUS))throw new Error("program link error: "+t.getProgramInfoLog(this._program));this._shader=e},t.prototype._updateActiveUniformInfos=function(t){this._uniformActiveInfosMap={};for(var e=t.getProgramParameter(this._program,t.ACTIVE_UNIFORMS),r=0;r<e;r++){var n=t.getActiveUniform(this._program,r),i=t.getUniformLocation(this._program,n.name);n.loc=i,this._uniformActiveInfosMap[n.name]=n}},t.prototype._updateMatrixUniformInfos=function(t){for(var e=this._uniformActiveInfosMap["u_matrix_array[0]"],r=0;r<this._matrixArrayLength;r++){var n={name:"u_matrix_array["+r+"]",type:e.type,size:1},i=t.getUniformLocation(this._program,n.name);n.loc=i,this._uniformActiveInfosMap[n.name]=n}},t.prototype._initAttributesLocation=function(t){for(var e=t.getProgramParameter(this._program,t.ACTIVE_ATTRIBUTES),r=0;r<e;r++){var n=t.getActiveAttrib(this._program,r),i=t.getAttribLocation(this._program,n.name);this._attributesLocation[n.name]=i}},t.prototype._isBoundBuffersDiff=function(t,e){return!this._vertexArrayObject||this._boundElementBuffer!==t.elementArrayBuffer||this._boundPaintVertexArrayBuffer!==t.paintVertexArrayBuffer||this._boundLayoutVertexBuffer!==t.vertexLayoutArrayBuffer||this._boundVertexOffset!==e.vertexOffset},t.prototype._destroyVAO=function(t){this._ext.deleteVertexArrayOES(t),t=null},t.prototype._enableBufferAttributes=function(t,e){if(e&&e.attributes)for(var r=0,n=e.attributes;r<n.length;r++){var i=n[r],o=i.name;if(void 0!==this._attributesLocation[o]){var s=this._attributesLocation[o];i.disabled?t.disableVertexAttribArray(s):t.enableVertexAttribArray(s)}}},t.prototype._vertexAttribPointer=function(t,e){for(var r=0,n=e.attributes;r<n.length;r++){var i=n[r];if(void 0!==this._attributesLocation[i.name]){var o=this._attributesLocation[i.name];i.disabled||t.vertexAttribPointer(o,i.components,t[i.type],!1,e.elementBytes,i.offset+(e.elementBytes*this._boundVertexOffset||0))}}},t.prototype.freshBindVAO=function(t,e,r){if(this._boundElementBuffer=e.elementArrayBuffer,this._boundPaintVertexArrayBuffer=e.paintVertexArrayBuffer,this._boundLayoutVertexBuffer=e.vertexLayoutArrayBuffer,this._boundVertexOffset=r.vertexOffset,this._boundDynamicVertexArrayBuffer=e.dynamicVertexArrayBuffer,this._boundDynamicVertexArrayBuffer2=e.dynamicVertexArrayBuffer2,this._ext){var n=r.vaos||(r.vaos={}),i=n[this._id];i&&this._destroyVAO(i),i=n[this._id]=this._ext.createVertexArrayOES(),this._ext.bindVertexArrayOES(i),r.ext=this._ext}else for(var o in this._attributesLocation)t.disableVertexAttribArray(this._attributesLocation[o]);this._enableBufferAttributes(t,this._boundLayoutVertexBuffer),this._boundLayoutVertexBuffer.bind(),this._vertexAttribPointer(t,this._boundLayoutVertexBuffer),this._boundPaintVertexArrayBuffer&&(this._enableBufferAttributes(t,this._boundPaintVertexArrayBuffer),this._boundPaintVertexArrayBuffer.bind(),this._vertexAttribPointer(t,this._boundPaintVertexArrayBuffer)),this._boundDynamicVertexArrayBuffer&&this._boundDynamicVertexArrayBuffer.arrayBuffer&&this._boundDynamicVertexArrayBuffer.arrayBuffer.byteLength>0&&(this._enableBufferAttributes(t,this._boundDynamicVertexArrayBuffer),this._boundDynamicVertexArrayBuffer.bind(),this._vertexAttribPointer(t,this._boundDynamicVertexArrayBuffer)),this._boundDynamicVertexArrayBuffer2&&this._boundDynamicVertexArrayBuffer2.arrayBuffer&&this._boundDynamicVertexArrayBuffer2.arrayBuffer.byteLength>0&&(this._enableBufferAttributes(t,this._boundDynamicVertexArrayBuffer2),this._boundDynamicVertexArrayBuffer2.bind(),this._vertexAttribPointer(t,this._boundDynamicVertexArrayBuffer2)),this._boundElementBuffer&&this._boundElementBuffer.bind()},t.prototype.bindUniform=function(t,e,r,n){void 0===n&&(n=!1);var i=this._uniformActiveInfosMap[e];if(i){if(this._lastUniformMap[e]!==r||n){var o,s=i.type,a=i.loc;o||(o=this._typeUniformFunMap[s]),o&&o(a,r),this._lastUniformMap[e]=r}}else;},t.prototype.draw=function(t,e){t.drawElements(t.TRIANGLES,3*e.primitiveLength,t.UNSIGNED_SHORT,3*e.primitiveOffset*2)},t.prototype.drawGLLine=function(t,e){t.drawElements(t.LINES,2*e.primitiveLength,t.UNSIGNED_SHORT,2*e.primitiveOffset*2)},t.prototype.drawPoint=function(t,e){t.drawElements(t.POINTS,e.primitiveLength,t.UNSIGNED_SHORT,1*e.primitiveOffset*2)},t}(),Pt=function(){function t(t,e){this._programCache={},this._initGL(t),this._dataBucket=e}return Object.defineProperty(t.prototype,"gl",{get:function(){return this._gl},enumerable:!0,configurable:!0}),t.prototype.useProgram=function(t){t&&this._currentProgram!==t&&(this._currentProgram=t,t.use(this._gl))},t.prototype.getCachedProgram=function(t){return this._programCache[t]},t.prototype.createProgram=function(t,e){var r=e?t+e:t;if(!this._programCache[r]){var n=vt[t+"_vertexSource"],i=vt[t+"_fragmentSource"];n&&i&&(this._programCache[r]=new Ot(this._gl,t,n,i,e))}return this._programCache[r]},t.prototype.clearColor=function(t){this._gl.clearColor(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this._gl.clear(this._gl.COLOR_BUFFER_BIT)},t.prototype._initGL=function(t){var e={alpha:!0,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,stencil:!0};this._gl=t.getContext("webgl",e)||t.getContext("experimental-webgl",e),this._gl.getExtension("OES_standard_derivatives")||console.warn("OES_standard_derivatives not supported")},t}(),Mt=function(){function t(t){return new Float64Array(t)}return t.create=function(){var e=new t(16);return e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},t.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},t.scale=function(t,e,r){var n=r[0],i=r[1],o=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},t.multiply=function(t,e,r){var n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],u=e[5],c=e[6],f=e[7],h=e[8],l=e[9],p=e[10],_=e[11],y=e[12],d=e[13],m=e[14],b=e[15],v=r[0],g=r[1],x=r[2],w=r[3];return t[0]=v*n+g*a+x*h+w*y,t[1]=v*i+g*u+x*l+w*d,t[2]=v*o+g*c+x*p+w*m,t[3]=v*s+g*f+x*_+w*b,v=r[4],g=r[5],x=r[6],w=r[7],t[4]=v*n+g*a+x*h+w*y,t[5]=v*i+g*u+x*l+w*d,t[6]=v*o+g*c+x*p+w*m,t[7]=v*s+g*f+x*_+w*b,v=r[8],g=r[9],x=r[10],w=r[11],t[8]=v*n+g*a+x*h+w*y,t[9]=v*i+g*u+x*l+w*d,t[10]=v*o+g*c+x*p+w*m,t[11]=v*s+g*f+x*_+w*b,v=r[12],g=r[13],x=r[14],w=r[15],t[12]=v*n+g*a+x*h+w*y,t[13]=v*i+g*u+x*l+w*d,t[14]=v*o+g*c+x*p+w*m,t[15]=v*s+g*f+x*_+w*b,t},t.translate=function(t,e,r){var n,i,o,s,a,u,c,f,h,l,p,_,y=r[0],d=r[1],m=r[2];return e===t?(t[12]=e[0]*y+e[4]*d+e[8]*m+e[12],t[13]=e[1]*y+e[5]*d+e[9]*m+e[13],t[14]=e[2]*y+e[6]*d+e[10]*m+e[14],t[15]=e[3]*y+e[7]*d+e[11]*m+e[15]):(n=e[0],i=e[1],o=e[2],s=e[3],a=e[4],u=e[5],c=e[6],f=e[7],h=e[8],l=e[9],p=e[10],_=e[11],t[0]=n,t[1]=i,t[2]=o,t[3]=s,t[4]=a,t[5]=u,t[6]=c,t[7]=f,t[8]=h,t[9]=l,t[10]=p,t[11]=_,t[12]=n*y+a*d+h*m+e[12],t[13]=i*y+u*d+l*m+e[13],t[14]=o*y+c*d+p*m+e[14],t[15]=s*y+f*d+_*m+e[15]),t},t.rotateX=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[4],s=e[5],a=e[6],u=e[7],c=e[8],f=e[9],h=e[10],l=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+c*n,t[5]=s*i+f*n,t[6]=a*i+h*n,t[7]=u*i+l*n,t[8]=c*i-o*n,t[9]=f*i-s*n,t[10]=h*i-a*n,t[11]=l*i-u*n,t},t.rotateZ=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],s=e[1],a=e[2],u=e[3],c=e[4],f=e[5],h=e[6],l=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+c*n,t[1]=s*i+f*n,t[2]=a*i+h*n,t[3]=u*i+l*n,t[4]=c*i-o*n,t[5]=f*i-s*n,t[6]=h*i-a*n,t[7]=l*i-u*n,t},t.ortho=function(t,e,r,n,i,o,s){var a=1/(e-r),u=1/(n-i),c=1/(o-s);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*a,t[13]=(i+n)*u,t[14]=(s+o)*c,t[15]=1,t},t.perspective=function(t,e,r,n,i){var o,s=1/Math.tan(e/2);return t[0]=s/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(o=1/(n-i),t[10]=(i+n)*o,t[14]=2*i*n*o):(t[10]=-1,t[14]=-2*n),t},t.transpose=function(t,e){if(t===e){var r=e[1],n=e[2],i=e[3],o=e[6],s=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=o,t[11]=e[14],t[12]=i,t[13]=s,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},t.invert=function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],s=e[4],a=e[5],u=e[6],c=e[7],f=e[8],h=e[9],l=e[10],p=e[11],_=e[12],y=e[13],d=e[14],m=e[15],b=r*a-n*s,v=r*u-i*s,g=r*c-o*s,x=n*u-i*a,w=n*c-o*a,A=i*c-o*u,O=f*y-h*_,P=f*d-l*_,M=f*m-p*_,L=h*d-l*y,B=h*m-p*y,j=l*m-p*d,T=b*j-v*B+g*L+x*M-w*P+A*O;return T?(T=1/T,t[0]=(a*j-u*B+c*L)*T,t[1]=(i*B-n*j-o*L)*T,t[2]=(y*A-d*w+m*x)*T,t[3]=(l*w-h*A-p*x)*T,t[4]=(u*M-s*j-c*P)*T,t[5]=(r*j-i*M+o*P)*T,t[6]=(d*g-_*A-m*v)*T,t[7]=(f*A-l*g+p*v)*T,t[8]=(s*B-a*M+c*O)*T,t[9]=(n*M-r*B-o*O)*T,t[10]=(_*w-y*g+m*b)*T,t[11]=(h*g-f*w-p*b)*T,t[12]=(a*P-s*L-u*O)*T,t[13]=(r*L-n*P+i*O)*T,t[14]=(y*v-_*x-d*b)*T,t[15]=(f*x-h*v+l*b)*T,t):null},t.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},t}(),Lt=function(){function t(t){return new Float64Array(t)}return t.create=function(){return new t(4)},t.fromValues=function(e,r,n,i){void 0===e&&(e=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=1);var o=new t(4);return o[0]=e,o[1]=r,o[2]=n,o[3]=i,o},t.transformMat4=function(t,e,r){var n=e[0],i=e[1],o=e[2],s=e[3];return t[0]=r[0]*n+r[4]*i+r[8]*o+r[12]*s,t[1]=r[1]*n+r[5]*i+r[9]*o+r[13]*s,t[2]=r[2]*n+r[6]*i+r[10]*o+r[14]*s,t[3]=r[3]*n+r[7]*i+r[11]*o+r[15]*s,t},t}(),Bt=function(){function t(t){this._loc=new n(0,0,0),this._fov=.4435011087932844,this._currentPitch=0,this._currentAngle=0,this._scale=1,this._pixelHeight=t.canvas.offsetHeight,this._pixelWidth=t.canvas.offsetWidth,this.setLoc(new n(0,0,0)),this.setPitch(1)}return Object.defineProperty(t.prototype,"mvpMatrix",{get:function(){return this._mvpMatrix},enumerable:!0,configurable:!0}),t.prototype.setLoc=function(t){this._loc=t,this._updateMVPMatrix(),this._updatePixelMatrix()},t.prototype.setPitch=function(t){this._currentPitch=t,this._updateMVPMatrix(),this._updatePixelMatrix()},t.prototype.pixelToCoordinate=function(t){var e=Lt.create(),r=Lt.create();Lt.transformMat4(e,[t.x,t.y,0,1],this._pixelMatrixReverse),Lt.transformMat4(r,[t.x,t.y,1,1],this._pixelMatrixReverse);var i=(e[2]/e[3]*r[0]/r[3]-e[0]/e[3]*r[2]/r[3])/(e[2]/e[3]-r[2]/r[3]),o=(e[2]/e[3]*r[1]/r[3]-r[2]/r[3]*e[1]/e[3])/(e[2]/e[3]-r[2]/r[3]),s=new n(i,o,0),a=Lt.create();return Lt.transformMat4(a,[i,o,0,1],this._modelViewMatrix),a[2]>=0&&console.warn("The point are beyond the scope of the screen and the projection is incorrect."),s},t.prototype.setAngle=function(t){this._currentAngle=t,this._updateMVPMatrix(),this._updatePixelMatrix()},t.prototype._updateMVPMatrix=function(){this._pixelToWorldCenter=.5*this._pixelHeight/Math.tan(this._fov/2);this._currentPitch,Math.PI;var t=this._pixelToWorldCenter*Math.sin(this._fov/2)/Math.sin(Math.PI/2-this._fov/2-this._currentPitch);this._viewPixelDistance=1.01*(t*Math.cos(Math.PI/2-this._currentPitch)+this._pixelToWorldCenter);var e=this._pixelWidth/this._pixelHeight;this._modelViewMatrix=Mt.create(),Mt.scale(this._modelViewMatrix,this._modelViewMatrix,[1,-1,1]),Mt.translate(this._modelViewMatrix,this._modelViewMatrix,[0,0,-this._pixelToWorldCenter]),Mt.rotateX(this._modelViewMatrix,this._modelViewMatrix,this._currentPitch),Mt.rotateZ(this._modelViewMatrix,this._modelViewMatrix,this._currentAngle),Mt.translate(this._modelViewMatrix,this._modelViewMatrix,[-this._loc.x*this._scale,-this._loc.y*this._scale,0]),Mt.scale(this._modelViewMatrix,this._modelViewMatrix,[1,1,this._scale,1]),this._projMatrix=Mt.create(),Mt.perspective(this._projMatrix,this._fov,e,1,this._viewPixelDistance),this._mvpMatrix=Mt.create(),Mt.multiply(this._mvpMatrix,this._projMatrix,this._modelViewMatrix)},t.prototype._updatePixelMatrix=function(){var t=Mt.create();if(Mt.scale(t,t,[this._pixelWidth/2,-this._pixelHeight/2,1]),Mt.translate(t,t,[1,-1,0]),Mt.multiply(t,t,this._mvpMatrix),this._pixelMatrix=t,this._pixelMatrixReverse=Mt.invert(Mt.create(),this._pixelMatrix),!this._pixelMatrixReverse)throw new Error("Fail to reverse pixel matrix")},t}(),jt=function(){function t(){}return Object.defineProperty(t,"dpr",{get:function(){return t._dpr?t._dpr:(t._dpr=window.devicePixelRatio||1,t._dpr)},enumerable:!0,configurable:!0}),t}(),Tt=function(){function t(t){this._canvas=t,this._resizeCanvas(t.offsetWidth,t.offsetHeight)}return Object.defineProperty(t.prototype,"canvas",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),t.prototype._resizeCanvas=function(t,e){this.canvas.width=jt.dpr*t,this.canvas.height=jt.dpr*e,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px"},t}(),Vt=r(6),St=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Et={};Et[87]=new n(0,-1,0),Et[65]=new n(-1,0,0),Et[83]=new n(0,1,0),Et[68]=new n(1,0,0);var Ft=function(t){function e(e){var r=t.call(this)||this;return r._nowFrameEvent={},r.keyDown=r.keyDown.bind(r),r.keyUp=r.keyUp.bind(r),r._element=e,document.addEventListener("keydown",r.keyDown),document.addEventListener("keyup",r.keyUp),r._getNowFrameEvent(),r}return St(e,t),e.prototype.keyDown=function(t){var e=t.keyCode;Et[e]&&(this._nowFrameEvent[e]=Et[e])},e.prototype.keyUp=function(t){t.keyCode;this._nowFrameEvent[t.keyCode]&&delete this._nowFrameEvent[t.keyCode]},e.prototype._getNowFrameEvent=function(){var t=this,e=function(){window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){var r=new n(0,0,0);Object.keys(t._nowFrameEvent).forEach(function(e){r.add(t._nowFrameEvent[e])}),0!==r.mag()?(r.unit(),r.mult(.01),t.emit("change_speed",r),e()):e()})})};e()},e}(Vt.EventEmitter),Ct=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Ut={Connecting:0,Connected:1,Closed:2},It=function(t){function e(e){}return Ct(e,t),e.prototype.send=function(t){this._ws.send(t)},e.prototype._onOpen=function(){console.log("connect success"),this.emit(new y("consuccess")),this._status=Ut.Connected},e.prototype._onMessage=function(t){this.emit(new y("onmessage",t.data)),console.log("get message")},e.prototype._onClose=function(){console.log("connnect closed"),this.emit(new y("conclose")),this._status=Ut.Closed},e}(o),Dt="ws://0.0.0.0:8989",kt={UPDATE:0,CREATE_BULLET:1},zt=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Rt=function(t){function e(e){var r=t.call(this)||this;return r._open=!1,r._player=e,r._ws=new It(Dt),r.on("connect success",r._startPushServer.bind(r)),r.on("connect closed",r._stopPushServer.bind(r)),r}return zt(e,t),e.prototype._startPushServer=function(){var t=this;if(!this._open){this._open=!0;var e=function(){window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){t._updatePlayer(),t._open&&e()})})})};e()}},e.prototype._updatePlayer=function(){var t=new Int32Array([kt.UPDATE].concat(this._player.loc.toArray()));this._ws.send(t.buffer)},e.prototype._stopPushServer=function(){this._open=!1},e}(o);r.d(e,"Game",function(){return Gt});var Nt=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Gt=function(t){function e(){var e=t.call(this)||this,r=document.getElementById("game");return e._viewPort=new Tt(r),e._renderer=new Pt(r),e._scene=new ft(30,30,e._renderer),e}return Nt(e,t),e.prototype.connectPlayer=function(){var t=new Bt(this._viewPort),e=new Ft(this._container),r=new F(this._container,t);this._player=new C({id:"shujingwei",secret:"sjwsjw",camera:t,keyboard:e,mouse:r}),this._scene.joinPlayer(this._player),this._connection=new Rt(this._player)},e.prototype.framePaint=function(){var t=this,e=function(){window.requestAnimationFrame(function(){t._scene.setView(t._player),t._renderer.clearColor([0,0,0,50]),t._scene.draw(),e()})};e()},e.prototype.start=function(){this.framePaint()},e}(o),Wt=new Gt;Wt.connectPlayer(),Wt.start()}])});